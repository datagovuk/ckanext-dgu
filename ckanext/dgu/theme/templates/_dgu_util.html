<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:i18n="http://genshi.edgewall.org/i18n"
  xmlns:py="http://genshi.edgewall.org/"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  py:strip=""
  >

  <!--! Herein can be found generic helper methods for a whole bunch of common
        templating issues -->

  <ul py:def="package_list_from_dict(packages)" class="datasets">
    <li py:for="package in packages"
        class="${'fullyopen' if (package.isopen and package.get('resources')) else None}">
        <div class="header">
      <span class="title">
        ${h.link_to(package.get('title') or package.get('name'), h.url_for(controller='package', action='read', id=package.get('name')))}
      </span>

      <div class="search_meta">
        <py:if test="package.resources">
          <ul class="dataset_formats">
            <py:for each="resource in package.resources">
              <py:if test="resource.get('format')">
                <li><a href="${resource.get('url')}"
                  title="${resource.get('description')}">${resource.get('format')}</a></li>
              </py:if>
            </py:for>
          </ul>
        </py:if>
        <ul class="openness">
          <py:if test="package.isopen">
            <li>
              <a href="http://opendefinition.org/okd/" title="This dataset satisfies the Open Definition.">
                  <img src="http://assets.okfn.org/images/ok_buttons/od_80x15_blue.png" alt="[Open Data]" />
              </a>
            </li>
          </py:if>
          <py:if test="not package.isopen">
            <li>
              <span class="closed">
                ${h.icon('lock')} Not Openly Licensed
              </span>
            </li>
          </py:if>
        </ul>
      </div>
		</div>
		<div class="extract">
			${h.markdown_extract(package.notes)}
		</div>
        <div class="owners">
            <p><b>Publisher:</b>
              <?python
                groups = package.get('groups', [])
                publishers = [ g for g in groups if g['type'] == 'publisher' ]
                publisher = publishers[0] if publishers else {'name':'', 'title': ''}
              ?>
              <a href="${h.url_for(controller='ckanext.dgu.controllers.publisher:PublisherController', action='read', id=publisher.get('name', ''))}">
                ${publisher.get('title', '')}
              </a>
            </p>
            <?python
                display_provider = False
                uklps = [d for d in package.get('extras', {}) if d['key'] == 'UKLP']
                is_uklp = uklps[0]['value'] == '"True"' if len(uklps) else False
                providers = [d for d in package.get('extras', {}) if d['key'] == 'provider']
                provider = providers[0]['value'] if len(providers) else ''
                display_provider = is_uklp or bool(provider)
            ?>
            <p py:if="display_provider"><b>Provider:</b> ${provider.strip('"')}</p>
        </div>
        <!--ul py:if="package.tags" class="tags">
          <li py:for="tag in package.tags">${tag.name}</li>
        </ul-->
    </li>
  </ul>


  <div py:def="facet_filters()" class="datasets">

    <div class="facet-box">
      <h2>Sort results</h2>
      <ul>
        <li py:if="c.sort_by_fields"><a href="${c.sort_by([])}">Relevancy</a></li>
        <li py:if="not c.sort_by_fields">Relevancy</li>
        <py:for each="field,title,order in [('titleString','Title','asc'), ('metadata_modified', 'Date Modified', 'desc')]">
          <li py:if="field not in c.sort_by_fields"><a href="${c.sort_by([(field,order)])}">${title}</a></li>
          <li py:if="field in c.sort_by_fields">${title}</li>
        </py:for>
      </ul>
    </div>

    ${facet_sidebar('tags', if_empty='There are no further tag filters to apply.')}
    ${facet_sidebar('res_format', title=lambda n:'Resource Format', if_empty='There are no further resource format filters to apply.', count_label=lambda c: '')}

    <!-- Create a nested list of UKLP filters -->
    <div class="facet-box">
      <h2>UKLP Dataset Type</h2>
      <ul py:if="len(h.facet_items(c, 'resource-type'))">
        ${facet_list_items('UKLP', label=lambda n: 'UKLP', if_empty='UKLP')}
        <ul class="facet-options">
          ${facet_list_items('resource-type')}
        </ul>
      </ul>
      <p py:if="not len(h.facet_items(c, 'resource-type'))">There are no further UKLP filters to apply.</p>
    </div>

    ${facet_sidebar('license_id-is-ogl', title=lambda n: 'License', label=lambda n: 'Open Government License' if n == 'true' else 'Non-Open Government License', if_empty='There are no further license filters to apply.')}

  </div>

</html>
