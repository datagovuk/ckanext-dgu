<html xmlns:py="http://genshi.edgewall.org/"
  xmlns:i18n="http://genshi.edgewall.org/i18n"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  py:strip="">

  <xi:include href="publisher_util.html" />

  <py:def function="page_title">${c.group.display_name}</py:def>

  <py:match path="breadcrumbs">
    <li><a href="/publisher">Publishers</a></li>
    <li><a href="/publisher/${c.group.name}">${c.group.display_name}</a></li>
  </py:match>

  <py:match path="content">
    <div class="dropdown-buttons">
      <span class="dropdown">
        <a data-toggle="dropdown" href="#">
          <i class="icon-envelope icon-2x"></i><div class="dropdown-chevron"></div>
        </a>
        <div class="panel panel-default dropdown-menu" role="menu" aria-labelledby="dLabel">
          <div class="panel-heading">Contacts</div>
          <div class="panel-body">
            <b>Enquiries:</b>
            <ul style="margin-bottom: 5px;">
              ${c.group_extras.get('contact-name')}
              ${contact_details(c.group_extras.get('contact-name'),
              c.group_extras.get('contact-email'),
              c.group_extras.get('contact-phone'),
              c.group_extras.get('website-url'),
              c.group_extras.get('website-name'))}
            </ul>
            <b class="js-tooltip" title="Use the Freedom of Information Act to request more information from the body holding the data">FOI requests</b>:
            <ul style="margin-bottom: 0;">
              ${c.group_extras.get('foi-name')}
              ${contact_details(c.group_extras.get('foi-name'),
              c.group_extras.get('foi-email'),
              c.group_extras.get('foi-phone'),
              c.group_extras.get('foi-web'), '')}
            </ul>
          </div>
        </div>
      </span>
      <span class="dropdown">
        <a data-toggle="dropdown" href="#"><i class="icon-sitemap icon-2x"></i><div class="dropdown-chevron"></div></a>
        <div class="dropdown-menu panel panel-default" role="menu" aria-labelledby="dLabel">
          <div class="panel-heading">Publisher Hierarchy</div>
          <div class="panel-body">
            <div id="publisher-tree" class="publisher-mini-tree">
              ${Markup(h.render_mini_tree(c.group.name))}
            </div>
          </div>
        </div>
      </span>
      <span class="dropdown">
        <a data-toggle="dropdown" href="#"><i class="icon-bar-chart icon-2x"></i><div class="dropdown-chevron"></div></a>
        <div class="panel panel-default dropdown-menu" role="menu" aria-labelledby="dLabel">
          <div class="panel-heading">Reports</div>
          <div class="panel-body">
            <ul>
              <li><a href="${h.url_for(controller='ckanext.dgu.controllers.reports:ReportsController', action='feedback', id=c.group.name)}">
              Feedback Report
              </a> <span style="color:#666;">(unpublished datasets)</span></li>
            </ul>
          </div>
        </div>
      </span>
      <span class="dropdown" py:if="c.userobj">
        <a data-toggle="dropdown" href="#"><i class="icon-group icon-2x"></i><div class="dropdown-chevron"></div></a>
        <div class="dropdown-menu" role="menu" aria-labelledby="dLabel">
          <b>Administrators:</b>
          <ul py:with="count = c.administrators.count()">
            <py:if test="c.is_an_official">
              <li py:for="admin in c.administrators">${h.linked_user(admin, maxlength=40)}</li>
            </py:if>
            <py:if test="not c.is_an_official">
              <li py:if="count">${count} administrator${h.pluralise_text(count)}</li>
              <li py:if="not count">No-one assigned</li>
            </py:if>
          </ul>
          <b>Editors:</b>
          <ul py:with="count = c.editors.count()">
            <py:if test="c.is_an_official">
              <li py:for="editor in c.editors">${h.linked_user(editor, maxlength=35)}</li>
            </py:if>
            <py:if test="not c.is_an_official">
              <li py:if="count">${count} editor${h.pluralise_text(count)}</li>
              <li py:if="not count">No-one assigned</li>
            </py:if>
            <li py:if="not c.userobj in c.administrators and not c.userobj in c.editors">
              <b><a href="${h.url_for(controller='ckanext.dgu.controllers.publisher:PublisherController', action='apply', id=c.group.name)}">
                  <u>Request to become an ${if_(not c.administrators.count(),'Admin/')}Editor</u> &nbsp;&raquo;
              </a></b>
            </li>
          </ul>
        </div>
      </span>
      <span class="dropdown">
        <a class="rss-link rss-link-grey" href="${h.url(controller='feed', action='group', id=c.group['name'])}" title="${g.site_title} - Datasets in group '${c.group['title']}'"><i class="icon-rss icon-2x"></i></a>
      </span>
    </div>
    <h1>${c.group.display_name}
      <span class="abbreviation" py:if="c.group_extras.get('abbreviation')">(${c.group_extras.get('abbreviation')})</span>
    </h1>
    <py:if test="c.group['state'] != 'active'">
      <div class="panel panel-danger">
        <div class="panel-heading"><strong>State:</strong> ${c.group['state']}</div>
      </div>
    </py:if>
    <div class="row" py:with="
      packagecreate = h.check_access('package_create', {'owner_org':c.group.name});
      organizationupdate = h.check_access('organization_update', {'id':c.group.id});
      adminmode = (packagecreate or packagecreate)"
      >
      <div class="${if_(adminmode,'col-md-8','col-md-12')}">
        <p py:if="h.group_category(c.group_extras)" class="pre-notes">
          <b>Category: </b> ${h.group_category(c.group_extras)}
        </p>
        <p py:if="h.spending_published_by(c.group_extras)" class="pre-notes">
          <b>Spending data published by: </b> <a href="/publisher/${h.spending_published_by(c.group_extras).name}">${h.spending_published_by(c.group_extras).title}</a>
        </p>
        <div class="notes">
          <span py:if="not str(c.description).strip()" style="font-style: italic;">(No description supplied)</span>
          ${h.render_markdown(c.description)}
        </div>
      </div>
      <div class="col-md-4" py:if="adminmode">
        <div class="admin-toolkit">
          <div class="panel panel-info">
            <div class="panel-heading" style="font-weight: bold;">Administrator Tools</div>
            <div class="panel-body">
              <ul class="administrator-tools">
                <li py:if="organizationupdate">
                  <a href="${h.url_for(controller='ckanext.dgu.controllers.publisher:PublisherController', action='edit', id=c.group.name)}"><span class="wrap-icon"><i class="icon-edit"></i> </span>Edit publisher properties &raquo;</a>
                </li>
                <li py:if="organizationupdate">
                  <a href="${h.url_for(controller='ckanext.dgu.controllers.inventory:InventoryController', action='edit',id=c.group.name)}"><span class="wrap-icon"><i class="icon-archive"></i> </span>Manage unpublished datasets &raquo;</a>
                </li>
                <li py:if="packagecreate">
                  <a href="${h.url_for('dataset_new')}?owner_org=${c.group.name}"><span class="wrap-icon"><i class="icon-plus-sign-alt"></i> </span>Add a new dataset &raquo;</a>
                </li>
                <li py:if="organizationupdate">
                  <a href="${h.url_for(controller='ckanext.dgu.controllers.publisher:PublisherController', action='users', id=c.group.name)}"><span class="wrap-icon"><i class="icon-unlock-alt"></i> </span>Edit user permissions &raquo;</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    ${search_form(placeholder='Search publisher')}
    <!--
     TODO restore this code to make searches work proper. And be autocompleted.
    <py:for each="(k, v) in c.fields">
      <input type="hidden" name="${k}" value="${v}" />
    </py:for>
    <input type="submit" value="${_('Search')}" class="btn btn-primary button" />
    <form action="">
      <label class="checkbox">
        <input type="checkbox" name="publisher-results-include-subpub" value="${c.drill_down_url(publisher=c.group.name) if not c.restricted_to_publisher else c.remove_field('publisher', c.group.name)}" class="inline" py:attrs="{'checked': 'checked'} if not c.restricted_to_publisher else {}"/>
        Include datasets from sub-publishers
      </label>
    </form>
    -->

    <h2>Popular Datasets</h2>
    <!--div py:if="h.ga_report_installed()" class="widget-container">
      <h4>Popular datasets</h4>
      ${h.most_popular_datasets(c.group, 5, preview_image="/images/graph_preview_thumbnail.png")}
    </div -->
    <!-- TODO are these in order of popularity? -->
    <div py:if="c.page.items">
      ${package_list_from_dict(c.page.items)}
      ${c.page.pager()}
    </div>
  </py:match>

  <py:def function="optional_feed">
    <link rel="alternate" type="application/atom+xml" title="${g.site_title} - Datasets in group '${c.group['title']}'"
      href="${h.url(controller='feed', action='group', id=c.group['name'])}" />
  </py:def>

  <py:def function="optional_footer">
    ${publisher_sub_hierarchy(c.parent_publisher.name if c.parent_publisher else '', c.group.name)}
  </py:def>

  <xi:include href="../layout.html" />
</html>


