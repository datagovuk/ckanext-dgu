{% extends "page.html" %}
{% import "_dgu_jinja_util.html" as m with context %}

{% block title %}{{c.group.display_name}}{% endblock %}


{% block breadcrumb_content %}
  {{ h.build_nav('publisher_index', _('Publishers')) }}
  {{ h.build_nav('publisher_read', c.group.title, id=c.group.name) }}
{% endblock %}

{% macro publisher_extra_options() %}
  <label class="checkbox" id="publisher-extra-options">
    <input type="checkbox" name="publisher-results-include-subpub" class="inline" />
    Include datasets from sub-publishers
  </label>
{% endmacro %}

{% macro render_child(pub) %}
  <div class="publisher">
    <div class="publisher-row {{m.if_(pub['name']==c.group.name,'active')}}">
      <a href="/publisher/{{pub['name']}}">{{pub['title']}}</a>
    </div>
    {% for child in pub['children'] %}
      {{render_child(child)}}
    {% endfor %}
  </div>
{% endmacro %}

{% block primary_content_inner %}
    <div class="dropdown-buttons">
      <span class="dropdown">
        <a href="#" class="js-tooltip dropdown-button" data-placement="top" data-delay="300" data-toggle="dropdown" title="" data-original-title="Contact&nbsp;Details">
          <i class="icon-envelope icon-2x"></i>
          <div class="dropdown-chevron"></div>
        </a>
        <div class="panel panel-default dropdown-menu" role="menu" aria-labelledby="dLabel">
          <div class="panel-heading">Contacts</div>
          <div class="panel-body">
            <b>Enquiries:</b>
            <ul style="margin-bottom: 5px;">
              {{c.group_extras.get('contact-name')}}
              {{m.contact_details(c.group_extras.get('contact-name'),
                c.group_extras.get('contact-email'),
                c.group_extras.get('contact-phone'),
                c.group_extras.get('website-url'),
                c.group_extras.get('website-name'))}}
            </ul>
            <b class="js-tooltip" title="Use the Freedom of Information Act to request more information from the body holding the data">FOI requests</b>:
            <ul style="margin-bottom: 0;">
              {{c.group_extras.get('foi-name')}}
              {{m.contact_details(c.group_extras.get('foi-name'),
                c.group_extras.get('foi-email'),
                c.group_extras.get('foi-phone'),
                c.group_extras.get('foi-web'), '')}}
            </ul>
          </div>
        </div>
      </span>
      <span class="dropdown js-trigger-publisher-scroll">
        <a href="#" class="js-tooltip dropdown-button" data-placement="top" data-delay="300" data-toggle="dropdown" title="" data-original-title="Publisher&nbsp;Hierarchy">
          <i class="icon-sitemap icon-2x"></i>
          <div class="dropdown-chevron"></div>
        </a>
        <div class="dropdown-menu panel panel-default" role="menu" aria-labelledby="dLabel">
          <div class="panel-heading">Publisher Hierarchy</div>
          <div class="panel-body publisher-dropdown">

            <div class="publisher-hierarchy empty-search">
              {% with %}
                {% set pub=h.publisher_hierarchy_mini(c.group.name) %}
              <div class="publisher">
                <div class="publisher-row {{m.if_(pub['name']==c.group.name,'active')}}">
                  <a href="/publisher/{{pub['name']}}">{{pub['title']}}</a>
                </div>
                {% for child in pub['children'] %}
                  {{render_child(child)}}
                {% endfor %}
              </div>
              {% endwith %}
            </div>
          </div>
        </div>
      </span>
      <span class="dropdown">
        <a href="#" class="js-tooltip dropdown-button" data-placement="top" data-delay="300" data-toggle="dropdown" title="" data-original-title="Reports&nbsp;&amp;&nbsp;Analytics">
          <i class="icon-bar-chart icon-2x"></i>
          <div class="dropdown-chevron"></div>
        </a>
        <div class="panel panel-default dropdown-menu" role="menu" aria-labelledby="dLabel">
          <div class="panel-heading">Reports</div>
          <div class="panel-body">
            <ul>
              <li><a href="{{h.url_for('report-org', report_name='broken-links', organization=c.group.name)}}">
              Broken links report</a></li>

              <li><a href="{{h.url_for('report-org', report_name='feedback', organization=c.group.name)}}">
              Feedback report</a></li>

              <li><a href="{{h.url_for('report-org', report_name='openness', organization=c.group.name)}}">
              Openness report</a></li>

              {% if h.has_commitment(c.group) %}
              <li><a href="{{h.url_for('commitments_publisher', id=c.group.name)}}">
              Data publication commitments</a></li>
              {% endif %}

              <li><a href="/data/site-usage/publisher/{{c.group.name}}">Dataset analytics</a></li>

              <!--!  Not ready yet
              <li py:if="h.check_access('package_create', {'owner_org':c.group.name})"><a href="${h.url_for('activity_reports', id=c.group.name)}">Activity report</a></li>
              -->
            </ul>
          </div>
        </div>
      </span>
      {% if c.userobj %}
      <span class="dropdown">
        <a href="#" class="js-tooltip dropdown-button" data-placement="top" data-delay="300" data-toggle="dropdown" title="" data-original-title="Administrators">
          <i class="icon-group icon-2x"></i>
          <div class="dropdown-chevron"></div>
        </a>
        <div class="dropdown-menu" role="menu" aria-labelledby="dLabel">
          <b>Administrators:</b>
          {% with %}
          {% set count = c.administrators.count() %}
          <ul>
            {% if c.is_an_official %}>
              {% for admin in c.administrators %}
              <li>{{h.linked_user(admin, maxlength=40)}}</li>
              {% endfor %}
            {% else %}
              {% if count %}
              <li>{{count}} administrator{{h.pluralise_text(count)}}</li>
              {% else %}
              <li>No-one assigned</li>
              {% endif %}
            {% endif %}
          </ul>
          {% endwith %}
          <b>Editors:</b>
          {% with %}
          {% set count = c.editors.count() %}
          <ul>
            {% if c.is_an_official %}
              {% for editor in c.editors %}
              <li>{{h.linked_user(editor, maxlength=35)}}</li>
              {% endfor %}
            {% else %}
              {% if count %}
                <li>{{count}} editor{{h.pluralise_text(count)}}</li>
              {% else %}
                <li>No-one assigned</li>
              {% endif %}
            {% endif %}
            {% if not c.userobj in c.administrators and not c.userobj in c.editors %}
            <li>
              <b><a href="{{h.url_for(controller='ckanext.dgu.controllers.publisher:PublisherController', action='apply', id=c.group.name)}}">
                  <u>Request to become an {{m.if_(not c.administrators.count(),'Admin/')}}Editor</u> &nbsp;&raquo;
              </a></b>
            </li>
            {% endif %}
          </ul>
          {% endwith %}
        </div>
      </span>
      {% endif %}

      <a class="js-tooltip dropdown-button rss-link" data-placement="top" title="" data-delay="300" data-original-title="RSS&nbsp;Feed" href="{{h.url(controller='feed', action='organization', id=c.group['name'])}}">
        <i class="icon-rss icon-2x"></i>
      </a>
    </div>
    <h1>{{c.group.display_name}}
      {% if c.group_extras.get('abbreviation') %}
      <span class="abbreviation">({{c.group_extras.get('abbreviation')}})</span>
      {% endif %}
    </h1>
    {% if c.group['state'] != 'active' %}
      <div class="panel panel-danger">
        <div class="panel-heading"><strong>State:</strong> {{c.group['state']}}</div>
      </div>
    {% endif %}

    {% with %}
      {% set packagecreate = h.check_access('package_create', {'owner_org':c.group.name}) %}
      {% set organizationupdate = h.check_access('organization_update', {'id':c.group.id}) %}
      {% set adminmode = (packagecreate or organizationupdate) %}
    <div class="row">
      <div class="{{m.if_(adminmode,'col-md-8','col-md-12')}}">
        {% if c.group_extras.get('closed', False) == 'true' -%}
        <div class="alert alert-info">
        This publisher is closed and no longer exists.
        </div>
        {%- endif %}

        {% if h.group_category(c.group_extras) %}
        <p class="pre-notes">
          <b>Category: </b> {{h.group_category(c.group_extras)}}
        </p>
        {% endif %}

        {% if h.spending_published_by(c.group_extras) %}
        <p class="pre-notes">
          <b>Spending data published by: </b> <a href="/publisher/{{h.spending_published_by(c.group_extras).name}}">{{h.spending_published_by(c.group_extras).title}}</a>
        </p>
        {% endif %}
        {% set description = (c.description or '') %}
        <div class="notes">
          {{h.render_markdown(description)}}
        </div>
      </div>

      {% if adminmode %}
      <div class="col-md-4">
        <div class="admin-toolkit">
          <div class="panel panel-info">
            <div class="panel-heading" style="font-weight: bold;">Administrator Tools</div>
            <div class="panel-body">
              <ul class="administrator-tools">
                {% if organizationupdate %}
                <li>
                  <a href="{{h.url_for(controller='ckanext.dgu.controllers.publisher:PublisherController', action='edit', id=c.group.name)}}"><span class="wrap-icon"><i class="icon-edit"></i> </span>Edit publisher properties &raquo;</a>
                </li>
                <li>
                  <a href="{{h.url_for(controller='ckanext.dgu.controllers.inventory:InventoryController', action='edit',id=c.group.name)}}"><span class="wrap-icon"><i class="icon-archive"></i> </span>Manage unpublished datasets &raquo;</a>
                </li>
                {% endif %}

                {% if packagecreate %}
                <li>
                  <a href="{{h.url_for('dataset_new')}}?owner_org={{c.group.name}}"><span class="wrap-icon"><i class="icon-plus-sign-alt"></i> </span>Add a new dataset &raquo;</a>
                </li>
                {% endif %}
                {% if organizationupdate %}
                <li>
                  <a href="{{h.url_for(controller='ckanext.dgu.controllers.publisher:PublisherController', action='users', id=c.group.name)}}"><span class="wrap-icon"><i class="icon-unlock-alt"></i> </span>Edit user permissions &raquo;</a>
                </li>
                {% endif %}
              </ul>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    {% endwith %}

    {{
      m.search_form(
          placeholder='Search publisher',
          set_fields={'publisher':c.group.name},
          extra_options=publisher_extra_options,
    )}}

    <div class="clearfix" style="height: 30px;">&nbsp;</div>

    <h2>Popular Datasets</h2>
    {% if c.page.items %}
      <div>
        {{m.package_list_from_dict(c.page.items,mini=True)}}
      </div>
      <div>
        {{m.paginator(c.page)}}
      </div>
    {% endif %}

{% endblock %}

{% block optional_feed %}
    <link rel="alternate" type="application/atom+xml" title="{{g.site_title}} - Datasets in organization '{{c.group['title']}}'"
      href="{{h.url(controller='feed', action='organization', id=c.group['name'])}}" />
{% endblock %}

{% block optional_footer %}
    <script src="/scripts/dgu-publisher-read.min.js"></script>
{% endblock %}


