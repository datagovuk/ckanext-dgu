{% extends "package/read_common_jinja.html" %}

{% import "_dgu_jinja_util.html" as m with context %}

{% block title %}
  {{h.resource_display_name(c.resource)}} - Resources
{% endblock %}


{% block breadcrumb_content %}
  {{ h.build_nav('dgu_search', _('Datasets')) }}
    <li><a href="{{h.url_for(controller='package',action='read',id=c.pkg_dict['name'])}}">{{c.pkg_dict.get('title', c.pkg_dict['name'])}}</a></li>
    <li><a href="{{h.url_for(controller='package',action='resource_read',id=c.pkg_dict['name'],resource_id=c.resource.id)}}">{{h.resource_display_name(c.resource)}}</a></li>

    <li><a href="{{h.url_for(controller='ckanext.dgu.controllers.api:DguApiController',action='resource_api',dataset_id=c.pkg_dict['name'],resource_id=c.resource.id)}}">{{_('API')}}</a></li>

{% endblock %}


{% block primary_content_inner %}
  <div>
    {% set publisher = h.get_organization_from_resource(c.resource) %}

    <hr/>

    <h2>Resource: <span class="h2-subheading">&ldquo;{{h.resource_display_name(c.resource)}}&rdquo;</span></h2>


    <div class="well">
      <h3>Resource API schema</h3>
      <p>The API for this resource was autogenerated from the data at <a href="{{c.resource.url}}">{{c.resource.url}}</a> and contains <strong>{{ h.humanize_number(c.schema.meta.count) }}</strong> rows. The schema generated from the source data is shown below</p>
      <div class="row" style="background-color:#fff; border:solid 1px #ddd; padding: 8px;">
          <div class="col-md-6">
            <h3>Schema</h3>
            <table class="table table-condensed">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Type</th>
                  </tr>
                </thead>
                <tbody>
                   {% for k,v in c.schema.schema.iteritems() %}
                    <tr>
                        <td>{{k}}</td>
                        <td>{{v}}</td>
                    </tr>
                   {% endfor %}
                </tbody>
            </table>
          </div>
          <div class="col-md-6">
          </div>
      </div>

      <hr/>
      <h3>Using the API</h3>
      <p>Requests for data to the api are made by making a HTTP GET request to <strong>/api/3/action/datastore_search</strong> with a combination of the following parameters.</p>

      <table class="table table-condensed">
        <thead>
          <th>Parameter</th>
          <th>Description</th>
          <th>Default</th>
          <th>Optional/Required</th>
        </thead>
        <tbody>
          <tr>
            <td>resource_id</td>
            <td>The ID of the resource to search against. In this case <strong>{{c.resource.id}}</strong></td>
            <td></td>
            <td>Required</td>
          </tr>
          <tr style="border-bottom: solid 2px #ddd;">
              <td></td>
              <td><strong>Example:</strong> &amp;resource_id={{c.resource.id}} </td>
              <td></td>
              <td></td>
          </tr>
          <tr>
            <td>q</td>
            <td>Full text query. If it’s a string, it’ll search on all fields on each row. If it’s a dictionary as {“key1”: “a”, “key2”: “b”}, it’ll search on each specific field</td>
            <td></td>
            <td>Optional</td>
          </tr>
          <tr style="border-bottom: solid 2px #ddd;">
              <td></td>
              <td><strong>Example:</strong> &amp;q=smith or &amp;q={"name":"smith"}</td>
              <td></td>
              <td></td>
          </tr>
          <tr>
            <td>filters</td>
            <td>matching conditions to select, e.g {“key1”: “a”, “key2”: “b”}</td>
            <td></td>
            <td>Optional</td>
          </tr>
          <tr style="border-bottom: solid 2px #ddd;">
              <td></td>
              <td><strong>Example:</strong> &amp;filters={"name":"smith"}</td>
              <td></td>
              <td></td>
          </tr>
          <tr>
            <td>distinct</td>
            <td>return only distinct rows</td>
            <td>false</td>
            <td>Optional</td>
          </tr>
          <tr style="border-bottom: solid 2px #ddd;">
              <td></td>
              <td><strong>Example:</strong> &amp;distinct=true</td>
              <td></td>
              <td></td>
          </tr>
          <tr>
            <td>fields</td>
            <td>fields to return as a comma-separated list</td>
            <td>all field</td>
            <td>Optional</td>
          </tr>
          <tr style="border-bottom: solid 2px #ddd;">
              <td></td>
              <td><strong>Example:</strong> &amp;fields=location,size</td>
              <td></td>
              <td></td>
          </tr>
          <tr>
            <td>limit</td>
            <td>maximum number of rows to return</td>
            <td>100</td>
            <td>Optional</td>
          </tr>
          <tr style="border-bottom: solid 2px #ddd;">
              <td></td>
              <td><strong>Example:</strong> &amp;limit=10</td>
              <td></td>
              <td></td>
          </tr>
          <tr>
            <td>offset</td>
            <td>offset this number of rows</td>
            <td></td>
            <td>Optional</td>
          </tr>
          <tr style="border-bottom: solid 2px #ddd;">
              <td></td>
              <td><strong>Example:</strong> &amp;offset=50</td>
              <td></td>
              <td></td>
          </tr>
          <tr>
            <td>sort</td>
            <td>comma separated field names with ordering e.g.: “fieldname1, fieldname2 desc”</td>
            <td></td>
            <td>Optional</td>
          </tr>
          <tr style="border-bottom: solid 2px #ddd;">
              <td></td>
              <td><strong>Example:</strong> &amp;sort=name</td>
              <td></td>
              <td></td>
          </tr>
        </tbody>
      </table>

      <hr/>
      <h3>Examples</h3>

      <h4>The first 5 rows</h4>
      <a href="{{ c.host }}/api/3/action/datastore_search?resource_id={{c.resource.id}}&amp;limit=5" target="_blank">
      {{ c.host }}/api/3/action/datastore_search?resource_id={{c.resource.id}}&amp;limit=5
      </a>
      <iframe src="/api/3/action/datastore_search?resource_id={{c.resource.id}}&limit=5" width="100%"></iframe>

      <hr/>
      {% set random_field = h.random_value_from_list(c.schema.schema.keys()) or '_id' %}
      <h4>The first 5 rows sorted by the '{{random_field}}' field </h4>
      <a href="{{ c.host }}/api/3/action/datastore_search?resource_id={{c.resource.id}}&amp;limit=5&amp;sort='{{random_field}}'" target="blank">
      {{ c.host }}/api/3/action/datastore_search?resource_id={{c.resource.id}}&amp;limit=5&amp;sort='{{random_field}}'
      </a>
      <iframe src="/api/3/action/datastore_search?resource_id={{c.resource.id}}&limit=5&sort='{{random_field}}'" width="100%"></iframe>

    </div>

    <span class="insert-comment-thread"></span>
  </div>


{% endblock %}